name: Deploy DotNet HelloWorld to Azure Container App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ENVIRONMENT: dev
  LOCATION: East US
  IMAGE_NAME: ghcr.io/mani7reddy/dotnethelloworld:latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 1ï¸âƒ£ Checkout the repository
      # ---------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -------------------------------------
      # 2ï¸âƒ£ Login to Azure using Service Principal
      # -------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      # ------------------------------------------------------
      # 3ï¸âƒ£ Ensure required Azure resource providers are registered
      # ------------------------------------------------------
      - name: Register required Azure resource providers
        run: |
          echo "ðŸ” Registering Azure providers..."
          az provider register --namespace Microsoft.App --wait || true
          az provider register --namespace Microsoft.OperationalInsights --wait || true
          az provider register --namespace Microsoft.ContainerRegistry --wait || true
          echo "âœ… Provider registration complete."

      # -----------------------------------
      # 4ï¸âƒ£ Setup Terraform CLI
      # -----------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # -----------------------------------
      # 5ï¸âƒ£ Terraform Init
      # -----------------------------------
      - name: Terraform Init
        working-directory: infra
        run: terraform init -input=false
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # 6ï¸âƒ£ Ensure Terraform state is unlocked (safe)
      # -----------------------------------
      - name: Ensure Terraform state is unlocked
        working-directory: infra
        run: |
          echo "ðŸ” Checking for stale Terraform locks..."
          LOCK_ID=$(terraform state pull 2>/dev/null | jq -r '.serial' || echo "")
          if [ "$LOCK_ID" != "" ] && [ "$LOCK_ID" != "null" ]; then
            echo "âš ï¸ Detected Terraform lock ID: $LOCK_ID"
            echo "ðŸ§¹ Checking Azure Blob lock metadata..."
            az storage blob metadata show \
              --container-name tfstate \
              --name terraform.tfstate \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --auth-mode login || true

            echo "ðŸ”“ Attempting safe unlock..."
            terraform force-unlock -force "$LOCK_ID" || echo "âš ï¸ Unlock skipped due to missing metadata."
          else
            echo "âœ… No stale Terraform locks found."
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # 7ï¸âƒ£ Terraform Apply (with auto-retry)
      # -----------------------------------
      - name: Terraform Apply
        working-directory: infra
        run: |
          n=0
          until [ $n -ge 3 ]
          do
            terraform apply -auto-approve \
              -var="environment=$ENVIRONMENT" \
              -var="location=$LOCATION" \
              -var="image_name=$IMAGE_NAME" && break
            n=$((n+1))
            echo "â³ Lock or transient error detected, retrying in 30s (attempt $n)..."
            sleep 30
          done
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # ðŸ§¹ Cleanup Terraform Lock if Apply Failed
      # -----------------------------------
      - name: Cleanup Terraform Lock Blob on Failure
        if: failure()
        working-directory: infra
        run: |
          echo "ðŸ§¹ Terraform Apply failed â€” checking for stale state lock..."
          CONTAINER_NAME="tfstate"
          STATE_FILE="terraform.tfstate"
          STORAGE_ACCOUNT="${{ secrets.AZURE_STORAGE_ACCOUNT }}"

          echo "ðŸ” Checking blob metadata for $STORAGE_ACCOUNT/$CONTAINER_NAME/$STATE_FILE ..."
          az storage blob metadata show \
            --container-name "$CONTAINER_NAME" \
            --name "$STATE_FILE" \
            --account-name "$STORAGE_ACCOUNT" \
            --auth-mode login || true

          echo "âš ï¸ Attempting to clear stale lock metadata (if any)..."
          az storage blob metadata update \
            --container-name "$CONTAINER_NAME" \
            --name "$STATE_FILE" \
            --account-name "$STORAGE_ACCOUNT" \
            --metadata terraformlockid= \
            --auth-mode login || true

          echo "âœ… Stale lock metadata cleared (if present). Safe to re-run Terraform."
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # 8ï¸âƒ£ Capture the App URL Output
      # -----------------------------------
      - name: Get App URL
        id: get_app_url
        working-directory: infra
        run: terraform output -raw app_url > app_url.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # 9ï¸âƒ£ Display and Export App URL
      # -----------------------------------
      - name: Show App URL
        run: |
          echo "ðŸŒ Deployed App URL:"
          cat infra/app_url.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: false

      # -----------------------------------
      # ðŸ”Ÿ Export App URL to Job Output
      # -----------------------------------
      - name: Export App URL to Job Output
        id: export_app_url
        run: |
          APP_URL=$(cat infra/app_url.txt)
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… App URL exported: $APP_URL"

    outputs:
      app_url: ${{ steps.export_app_url.outputs.app_url }}
